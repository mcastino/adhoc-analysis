from query_utils import SnowflakeEngineengine = SnowflakeEngine()engine.connect()import pandas as pdquery = """WITH dates AS (  SELECT    date_started_at  FROM    ds_prod.model.dim_date  WHERE    date_started_at >= '2014-01-01'    AND is_date_completed),base_table AS (  SELECT    d.date_started_at,    experiment_group  FROM    dates AS d    CROSS JOIN (      VALUES        ('control'),        ('experiment')    ) AS t(experiment_group)),cohorts AS (  SELECT    date_trunc('day', signed_up_at) AS signup_date,    CASE      WHEN is_in_crm_global_holdout THEN 'control'      ELSE 'experiment'    END AS experiment_group,    count(1) users  FROM    ds_prod.model.dim_user  WHERE    is_in_crm_global_holdout IS NOT NULL    AND NOT is_internal_user  GROUP BY    1,    2),trials AS (  SELECT    trial_started_at,    provider,    brand_owning_user_id AS user_id  FROM    ds_prod.model.dim_subscription  WHERE    trial_started_at > '2019-01-01'    AND plan_name = 'Canva Pro'),trialling_users AS (  SELECT    date_trunc('day', trial_started_at) AS trial_start_date,    CASE      WHEN is_in_crm_global_holdout THEN 'control'      ELSE 'experiment'    END AS experiment_group,    count(      CASE        WHEN t.provider = 'internal' THEN 1      END    ) web_trialling_users,    count(      CASE        WHEN t.provider = 'google' THEN 1      END    ) android_trialling_users,    count(      CASE        WHEN t.provider = 'apple' THEN 1      END    ) ios_trialling_users,    count(1) trialling_users  FROM    ds_prod.model.dim_user AS u    JOIN trials AS t ON u.user_id = t.user_id  WHERE    u.is_in_crm_global_holdout IS NOT NULL    AND NOT u.is_internal_user  GROUP BY    1,    2),results AS (  SELECT    bt.date_started_at,    bt.experiment_group,    sum(coalesce(t.web_trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 27 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) web_trial_rate_28d,    sum(coalesce(t.web_trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 6 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) web_trial_rate_7d,    sum(coalesce(t.android_trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 27 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) android_trial_rate_28d,    sum(coalesce(t.android_trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 6 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) android_trial_rate_7d,    sum(coalesce(t.ios_trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 27 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) ios_trial_rate_28d,    sum(coalesce(t.ios_trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 6 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) ios_trial_rate_7d,    sum(coalesce(t.trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 27 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) trial_rate_28d,    sum(coalesce(t.trialling_users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN 6 preceding        AND current ROW    ) / nullif(      sum(coalesce(c.users, 0)) over (        PARTITION by bt.experiment_group        ORDER BY          bt.date_started_at ASC ROWS BETWEEN unbounded preceding          AND current ROW      ),      0    ) trial_rate_7d,    sum(coalesce(c.users, 0)) over (      PARTITION by bt.experiment_group      ORDER BY        bt.date_started_at ASC ROWS BETWEEN unbounded preceding        AND current ROW    ) group_size  FROM    base_table bt    LEFT JOIN cohorts c ON bt.date_started_at = c.signup_date    AND bt.experiment_group = c.experiment_group    LEFT JOIN trialling_users t ON bt.date_started_at = t.trial_start_date    AND bt.experiment_group = t.experiment_group)SELECT  date_started_at AS "Date",  DENSE_RANK() OVER (    ORDER BY      date_started_at DESC  ) AS "day_rank",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Experiment Group Size",  MAX(    CASE      WHEN experiment_group = 'control' THEN trial_rate_28d    END  ) "Control Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN trial_rate_28d    END  ) "Experiment Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'control' THEN web_trial_rate_28d    END  ) "Control Web Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN web_trial_rate_28d    END  ) "Experiment Web Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'control' THEN android_trial_rate_28d    END  ) "Control Android Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN android_trial_rate_28d    END  ) "Experiment Android Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'control' THEN ios_trial_rate_28d    END  ) "Control iOS Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN ios_trial_rate_28d    END  ) "Experiment iOS Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'control' THEN trial_rate_7d    END  ) "Control Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN trial_rate_7d    END  ) "Experiment Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'control' THEN web_trial_rate_7d    END  ) "Control Web Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN web_trial_rate_7d    END  ) "Experiment Web Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'control' THEN android_trial_rate_7d    END  ) "Control Android Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN android_trial_rate_7d    END  ) "Experiment Android Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'control' THEN ios_trial_rate_7d    END  ) "Control iOS Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN ios_trial_rate_7d    END  ) "Experiment iOS Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN trial_rate_28d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN trial_rate_28d      END    ),    0  ) - 1 "Relative Uplift Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN web_trial_rate_28d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN web_trial_rate_28d      END    ),    0  ) - 1 "Relative Uplift Web Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN android_trial_rate_28d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN android_trial_rate_28d      END    ),    0  ) - 1 "Relative Uplift Android Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN ios_trial_rate_28d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN ios_trial_rate_28d      END    ),    0  ) - 1 "Relative Uplift iOS Trial Rate - 28d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN trial_rate_7d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN trial_rate_7d      END    ),    0  ) - 1 "Relative Uplift Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN web_trial_rate_7d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN web_trial_rate_7d      END    ),    0  ) - 1 "Relative Uplift Web Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN android_trial_rate_7d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN android_trial_rate_7d      END    ),    0  ) - 1 "Relative Uplift Android Trial Rate - 7d",  MAX(    CASE      WHEN experiment_group = 'experiment' THEN ios_trial_rate_7d    END  ) / nullif(    MAX(      CASE        WHEN experiment_group = 'control' THEN ios_trial_rate_7d      END    ),    0  ) - 1 "Relative Uplift iOS Trial Rate - 7d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN trial_rate_28d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN trial_rate_28d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift Trials - 28d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN web_trial_rate_28d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN web_trial_rate_28d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift Web Trials - 28d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN android_trial_rate_28d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN android_trial_rate_28d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift Android Trials - 28d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN ios_trial_rate_28d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN ios_trial_rate_28d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift iOS Trials - 28d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN trial_rate_7d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN trial_rate_7d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift Trials - 7d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN web_trial_rate_7d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN web_trial_rate_7d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift Web Trials - 7d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN android_trial_rate_7d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN android_trial_rate_7d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift Android Trials - 7d",  (    MAX(      CASE        WHEN experiment_group = 'experiment' THEN ios_trial_rate_7d      END    ) - MAX(      CASE        WHEN experiment_group = 'control' THEN ios_trial_rate_7d      END    )  ) * MAX(    CASE      WHEN experiment_group = 'experiment' THEN group_size    END  ) "Uplift iOS Trials - 7d",  0 AS "zero_line"FROM  results rWHERE  r.date_started_at >= '2019-05-01'GROUP BY  1ORDER BY  1 DESC"""df = engine.run_query(query)# df['event_date'] = pd.to_datetime(df['event_date'])# df.set_index('event_date',inplace=True)# df.sort_index(inplace=True)# df['Year'] = df.index.year# df['doy'] = df.index.dayofyear# df_piv = pd.pivot_table(df, index = ['doy'],columns = ['Year'], values = ['web_trials'])# df_piv.plot()